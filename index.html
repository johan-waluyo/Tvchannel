<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IPTV Channel Player with Region Selector</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
<h2>IPTV Channel Player</h2>

<label for="regionSelect"><b>Region:</b></label>
<select id="regionSelect">
  <option value="all">ALL</option>
  <option value="sg">Singapore</option>
  <option value="my">Malaysia</option>
  <option value="id" selected>Indonesia</option>
  <option value="tw">Taiwan</option>
  <option value="cn">China</option>
  <option value="vn">Vietnam</option>
  <option value="kh">Cambodia</option>
</select>
<br><br>

<input type="text" id="searchBox" placeholder="Search channel name...">
<br><br>
<select id="channelSelect"></select>
<br><br>

<video id="video" controls width="640" height="360"></video>
<br>
Channel Stream URL:
<input type="text" id="channelUrlBox" style="width:60%" readonly>
<button onclick="copyUrl()">Copy</button>

<script>
const regionM3uUrls = {
  all: 'https://iptv-org.github.io/iptv/index.m3u',
  sg:  'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/sg.m3u',
  my:  'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/my.m3u',
  id:  'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/id.m3u',
  tw:  'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/tw.m3u',
  cn:  'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/cn.m3u',
  vn:  'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/vn.m3u',
  kh:  'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/kh.m3u'
};

let allChannels = []; // master channel list

// Fetch/parse .m3u file
async function fetchAndParseM3U(url) {
    const response = await fetch(url);
    const text = await response.text();

    const lines = text.split('\n');
    const channels = [];
    let currentName = '';
    for (const line of lines) {
        if (line.startsWith('#EXTINF')) {
            let match = line.match(/tvg-name="([^"]+)"/);
            if (match) {
                currentName = match[1];
            } else {
                let commaIndex = line.indexOf(',');
                currentName = (commaIndex !== -1) ? line.substr(commaIndex + 1).trim() : 'Unknown Channel';
            }
        }
        else if (line && !line.startsWith('#')) {
            channels.push({ name: currentName, url: line });
            currentName = '';
        }
    }
    return channels;
}

function loadChannels(channels, autoPlay = true) {
    const select = document.getElementById('channelSelect');
    select.innerHTML = '';
    channels.forEach((ch, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.textContent = ch.name;
        select.appendChild(option);
    });

    select.onchange = () => playChannel(channels[select.value].url);
    if (channels.length > 0 && autoPlay) {
        select.selectedIndex = 0;
        playChannel(channels[0].url);
    } else {
        document.getElementById('channelUrlBox').value = '';
        const video = document.getElementById('video');
        if (window.hls) window.hls.destroy();
        video.src = '';
    }
}

function playChannel(streamUrl) {
    const video = document.getElementById('video');
    document.getElementById('channelUrlBox').value = streamUrl;
    if (Hls.isSupported()) {
        if (window.hls) window.hls.destroy();
        window.hls = new Hls();
        window.hls.loadSource(streamUrl);
        window.hls.attachMedia(video);
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = streamUrl;
    }
}

// Search/filter for current channel list
document.getElementById('searchBox').addEventListener('input', function () {
    const keyword = this.value.toLowerCase();
    const filtered = allChannels.filter(ch => ch.name.toLowerCase().includes(keyword));
    loadChannels(filtered, false);
});

function copyUrl() {
    const urlBox = document.getElementById('channelUrlBox');
    urlBox.select();
    urlBox.setSelectionRange(0, 99999);
    document.execCommand('copy');
}

// When region changes, fetch and update channel list
document.getElementById('regionSelect').addEventListener('change', function() {
    const region = this.value;
    const url = regionM3uUrls[region] || regionM3uUrls['id'];
    document.getElementById('searchBox').value = '';
    fetchAndParseM3U(url).then(channels => {
        allChannels = channels;
        loadChannels(allChannels);
    });
});

// Initial load: Indonesia by default
window.addEventListener('DOMContentLoaded', function() {
    document.getElementById('regionSelect').value = 'id';
    const url = regionM3uUrls['id'];
    fetchAndParseM3U(url).then(channels => {
        allChannels = channels;
        loadChannels(allChannels);
    });
});
</script>
</body>
</html>

